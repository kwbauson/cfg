name: Build
on: [push, workflow_dispatch]
jobs:
  build:
    name: ${{ matrix.output }}
    strategy:
      fail-fast: false
      matrix:
        output:
          - checks
          - keith-xps
          - keith-desktop
          - kwbauson
          - keith-vm
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - run: nix -vL build .#${{ matrix.output }}
      - name: push to cachix
        run: |
          cachix authtoken "$CACHIX_AUTH_TOKEN"
          cachix push kwbauson result
        env:
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: note build path
        run: |
          git config user.name "$(git log -1 --pretty=format:'%an')"
          git config user.email "$(git log -1 --pretty=format:'%ae')"
          git fetch origin '+refs/notes/*:refs/notes/*'
          echo "${{ matrix.output }}: $(realpath result)" > message
          git notes show 2> /dev/null >> message
          git notes add --force --message "$(sort message | uniq -u)"
          git push origin 'refs/notes/*' || true
