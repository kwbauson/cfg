name: Build
on: { workflow_dispatch, push: { branches: [main] }, pull_request }
jobs:
  build:
    runs-on: [self-hosted, nix]
    steps:
      - uses: actions/checkout@v2.3.5
      - run: cachix authtoken '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - run: nix -vL --show-trace build
      - run: cachix push kwbauson result
  macos-checks:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: nixbuild/nix-quick-install-action@v7
        with:
          nix_version: 2.4pre20210908_3c56f62
          nix_conf: experimental-features = nix-command flakes
      - uses: cachix/cachix-action@v10
        with:
          name: kwbauson
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - run: nix -vL --show-trace build .#checks
