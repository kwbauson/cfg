#!/usr/bin/env bash
# ONLY_LINUX
# with-packages git nix jq bat
set -euo pipefail
repo=${2:-~/cfg}
cd "$repo"
updateRepo=${1:-github:kwbauson/cfg/$(git rev-parse --abbrev-ref HEAD)}

sourcesInfo=$(nix eval "$repo#sourcesInfo" --json)
updateSourcesInfo=$(nix eval "$repo#sourcesInfo" --json)

cache=~/.cache/updates-log
mkdir -p "$cache"
cd "$cache"
if [[ ! -e .git ]];then
  git init
fi

ignore='root git-fuzzy'

logs=$(
  (
    echo "$sourcesInfo" | jq -r 'keys[]' | while read source;do
      if echo "$source" | grep -qFxf <(echo "$ignore" | tr ' ' '\n');then continue; fi
      read owner repo current_rev < <(echo "$sourcesInfo" | jq -r "[.\"$source\"[\"owner\",\"repo\",\"rev\"]] | @tsv")
      new_rev=$(echo "$updateSourcesInfo" |  jq -r ".nodes.\"$source\".locked.rev")
      if [[ $current_rev != $new_rev ]];then
        echo "$input https://github.com/$owner/$repo $current_rev $new_rev"
      fi
    done
  ) | while read input url current_rev new_rev;do
    if ! git remote show | grep -qFx "$input";then
      git remote add "$input" "$url"
    fi
    echo Fetching "$input" 1>&2
    git fetch "$input"
    echo "----- $input -----"
    git -c color.ui=always log --pretty=oneline --abbrev-commit --reverse --no-merges "$current_rev".."$new_rev"
    echo
  done
)
echo "$logs" | bat --style plain
